<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="咸鱼">
    <meta name="author" content="9unk">
    
    <title>
        
            Elastic Stack笔记 |
        
        9unk Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.jpg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":false,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/logo.jpg","favicon":"/images/logo.jpg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"人初做事，如鸡伏卵，不舍而生气渐充。如燕营巢，不息而结构渐牢。如滋培之木，不见其长，有时而大。如有本之泉，不舍昼夜，盈科而后进，放乎四海。"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                9unk Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Elastic Stack笔记</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/logo.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">9unk</span>
                        
                            <span class="author-label">Lv5</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2020-04-30 11:14:25</span>
        <span class="mobile">2020-04-30 11:14</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/github/">github</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/ELK/">ELK</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>12.2k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>54 分钟</span>
        </span>
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="Elastic-Stack-简介"><a href="#Elastic-Stack-简介" class="headerlink" title="Elastic Stack 简介"></a>Elastic Stack 简介</h2><ul>
<li>什么是 Elastic Stack</li>
</ul>
<p>Elastic Stack  是一套技术解决方案简称为 ELK，是 Elastic 公司的一套开源项目。Elastic Stack 的原名是 ELK Stack  ，因为 5.0 版本后加入了小弟  Beats ，因此更名为 Elastic Stack。</p>
<p>ELK 指的是三个开源软件的首字母大写，即：Elasticsearch、Logstash 和 Kibana。</p>
<ul>
<li>Elasticsearch 是一个搜索和分析引擎（负责日志检索和存储）</li>
<li>Logstash 是一个服务器端的数据处理管道，可以同时从多个源获取数据，将其转换为 Elasticsearch 之类的“stash”。（负责日志的收集和分析、处理）</li>
<li>Kibana 允许用户在 Elasticsearch 中使用图表和图表可视化数据。</li>
</ul>
<p>业界，经常会组合使用 Elasticsearch、Logstash 和 Kibana 这三种技术，来实现分布式系统的日志管理及可视化，所以，这三种技术的组合就被称为“ELK Stack”。（负责日志的可视化）</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://waylau.com/images/post/20171221-elk.jpg"
                      alt="ELK Stack"
                ></p>
<h2 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Elasticsearch 是一个基于 Apache Lucene(TM) 的开源搜索引擎。无论在开源还是专有领域，Lucene 可以被认为是迄今为止最先进、性能最好的、功能最全的搜索引擎库。但是，Lucene 只是一个库。Lucene 本身并不提供高可用性及分布式部署。想要发挥其强大的作用，你需使用 Java 并要将其集成到你的应用中。Lucene 非常复杂，你需要深入的了解检索相关知识来理解它是如何工作的。</p>
<p>Elasticsearch 也是使用 Java 编写并使用 Lucene 来建立索引并实现搜索功能，但是它的目的是通过简单连贯的 RESTful API 让全文搜索变得简单并隐藏 Lucene 的复杂性。</p>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><h4 id="近实时（Near-Real-Time）"><a href="#近实时（Near-Real-Time）" class="headerlink" title="近实时（Near-Real-Time）"></a>近实时（Near-Real-Time）</h4><p>这里说的是 ES 的搜索是接近实时（NRT）的。首先搜索的时延定义为： <strong>某个新的文档从索引到可被搜索的时间</strong> 。注意这里是说新的文档，也就是说，我们的文档集合新增了一篇文档后，需要多久的时间才能把它给搜索出来。如果是马上就能搜出来，那么就是实时的。而 ES 提供的是 NRT，这里面的时间差默认是 1s</p>
<blockquote>
<p>实时分为准实时和近实时，准实时是毫秒级，近实时是秒级。</p>
</blockquote>
<h4 id="集群（Cluster）"><a href="#集群（Cluster）" class="headerlink" title="集群（Cluster）"></a>集群（Cluster）</h4><p>ES 是高可扩展的。可扩展一般有两方面，垂直扩展是基于单个机器的性能及容量的提升，而这个提升是有限的；水平扩展是得益于机器的增加，理论上是无限的。ES 的高可扩展是基于水平扩展的，使用集群的方式能够充分利用机器的增加去均衡搜索请求和文档存储，提供高性能的搜索服务。</p>
<p>每个 ES 集群包含一个或多个节点来存放数据，这些节点共同提供索引和搜索能力。区分集群的唯一表示就是集群的名称，所以每个节点是根据集群的名称去判断它是属于哪一个集群的。</p>
<p>集群的状态有 Green、Yellow 和 Red 三种：</p>
<ul>
<li><p><strong>Green</strong>：绿色，健康。所有的主分片和副本分片都可正常工作，集群 100% 健康。</p>
</li>
<li><p><strong>Yellow</strong>：黄色，预警。所有的主分片都可以正常工作，但至少有一个副本分片是不能正常工作的。此时集群可以正常工作，但是集群的高可用性在某种程度上被弱化。</p>
</li>
<li><p><strong>Red</strong>：红色，集群不可正常使用。集群中至少有一个分片的主分片及它的全部副本分片都不可正常工作。</p>
</li>
</ul>
<p>当集群状态显示 Red 时，虽然集群的查询操作还可以进行，但是也只能返回部分数据（其他正常分片的数据可以返回），而分配到这个分片上的写入请求将会报错，最终会导致数据的丢失。</p>
<h4 id="节点（Node）"><a href="#节点（Node）" class="headerlink" title="节点（Node）"></a>节点（Node）</h4><p>一台 ES 服务器就是一个节点，一个节点都必须加入到某一个集群。集群中的每个节点会随机分配一个节点名称。当节点运行时，他们会根据集群名称，自动组成集群。</p>
<p>节点的类型分为：master 节点，data 节点，client 节点</p>
<ul>
<li><p>主节点（master  node）：一个集群一定包含一个 master node。 master node管理集群范围内的所有变更，如索引节点的增删。但是 master node并不会涉及到数据的存储、变更和搜索操作。所以，在拥有多个节点的集群中，流量的增加不会使得主节点成为瓶颈。</p>
</li>
<li><p>数据节点（data node）：data node 负责数据的存储和相关的具体操作，比如索引数据的创建、修改、删除、搜索、聚合。</p>
</li>
<li><p>客户端节点（client node）：client node 负责请求分发、汇总等，该节点的功能等同于协调节点。其实任何节点都可以完成这样的工作，单独添加这个节点是为了提高并发性。</p>
</li>
<li><p>部落节点（Tribe Node）：Tribe Node 跨越多个集群，接收每个集群的状态，然后合并成一个全局的集群状态。它可以读写所有集群节点上的数据。</p>
</li>
<li><p>协调节点（Coordinating Node）：协调节点，是一种角色，而不是真实的 Elasticsearch 的节点，我们没有办法通过配置项来配置哪个节点为协调节点。集群中的任何节点都可以充当协调节点的角色。<br> 例如：<br> 当一个节点 A 收到用户的查询请求后，会把查询语句分发到其他的节点，然后合并各个节点返回的查询结果，最好返回一个完整的数据集给用户。在这个过程中，节点 A 扮演的就是协调节点的角色。由此可见，协调节点会对 CPU、Memory 和 I&#x2F;O 要求比较高。</p>
</li>
</ul>
<h4 id="索引（index）"><a href="#索引（index）" class="headerlink" title="索引（index）"></a>索引（index）</h4><p>简单来说，把 ES 的索引看作是关系型数据库的 DB 就很好理解了。索引是同类文档的集合，我们倾向于把比较相似的文档都放在一个索引。这个相似可以是内容特征的相似，也可以是时间的相近等。在一个集群中，索引的数量是可以任意的。</p>
<h4 id="类型（type）"><a href="#类型（type）" class="headerlink" title="类型（type）"></a>类型（type）</h4><p>type 理解为关系型数据库的 Table。</p>
<h4 id="映射（mapping）"><a href="#映射（mapping）" class="headerlink" title="映射（mapping）"></a>映射（mapping）</h4><p>所有文档写进索引之前会先进行分析，如何将输入的文本分割词条，哪些词条又会被过滤，这种行为被叫做映射（mapping），一般由用户自己定义规则。</p>
<h4 id="文档（Document）"><a href="#文档（Document）" class="headerlink" title="文档（Document）"></a>文档（Document）</h4><p>Document 理解为关系型数据库表中的行数据。</p>
<h4 id="字段（field）"><a href="#字段（field）" class="headerlink" title="字段（field）"></a>字段（field）</h4><p>field 理解为关系型数据库表中的一列数据。</p>
<h4 id="分片（shard）"><a href="#分片（shard）" class="headerlink" title="分片（shard）"></a>分片（shard）</h4><p>当一个索引的存储量超过了一个节点的存储能力，我们就需要多个节点去存储。因此 ES 提供了 sharding 的能力，就是将一个 index 可以分为多个 shard 分别存储在多个 node 上，以此来实现水平扩展能力。在创建 index 的时候，可自定义 shard 的数量，索引的主分片创建完成后就已经固定了，无法进行更改。</p>
<h4 id="副本分片（Replica）"><a href="#副本分片（Replica）" class="headerlink" title="副本分片（Replica）"></a>副本分片（Replica）</h4><p>副本分片最大的作用就是故障恢复。在网络环境中，有可能某个分片和节点无法访问，也有可能故障数据丢失，这个时候就需要用副本来恢复。副本这个概念是针对分片的，也就是说我们能够为一个分片创建一个或多个副本。原来的分片叫做主分片，copy 出来的叫副本分片，副本分片可随时调整。</p>
<h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><p>这里使用 elasticsearch-head 和 REST Ape  这两个插件</p>
<p> elasticsearch-head</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/y8eHgo7qsEGpYzU.png"
                      alt="elasticsearch-1.png"
                ></p>
<p> REST Ape</p>
<ol>
<li>新建一个 project</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/kCmb5OHlPN9SgIM.png"
                      alt="elasticsearch-2.png"
                ></p>
<ol start="2">
<li><p>新建一个请求</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/MDZJuIP2L5k8xCB.png"
                      alt="elasticsearch-3.png"
                ></p>
</li>
<li><p>使用 GET 请求，获取集群信息</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/goXv7WbUpfM3qIc.png"
                      alt="elasticsearch-4.png"
                ></p>
</li>
</ol>
<h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><p>使用 PUT 方法新建一个 test 索引</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT  http://192.168.56.130:9200/test</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span>: <span class="string">&quot;0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/F169UE2kVqnTeMW.png"
                      alt="elasticsearch-5.png"
                ></p>
<p>刷新 elasticsearch-head 后，看到 test 索引新建成功</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/bYvekcI8fAwKzNX.png"
                      alt="elasticsearch-6.png"
                ></p>
<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE http://192.168.56.130:9200/test</span><br></pre></td></tr></table></figure>

<p>直接将请求改为 delete，将 body 请求体设为 no body</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/KpGwEJa5bUSF4tv.png"
                      alt="elasticsearch-7.png"
                ></p>
<p>刷新 elasticsearch-head 后，看到 test 索引删除成功</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/xFkHSwQfci1bVp8.png"
                      alt="elasticsearch-8.png"
                ></p>
<h4 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h4><p>使用 post 方式提交数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/test/user/1001</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>:1001,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:<span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:20,</span><br><span class="line">  <span class="string">&quot;sex&quot;</span>:<span class="string">&quot;男&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/FvOgpIQxesf95PA.png"
                      alt="elasticsearch-9.png"
                ></p>
<p>到 elasticsearch-head 数据浏览中查看 test 索引的数据</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/TvUnkwF6IgZ9xWN.png"
                      alt="elasticsearch-10.png"
                ></p>
<blockquote>
<p>user：类型名称<br> 1001：指定数据唯一标识（默认随机生成）<br> _index: 索引名称<br>_type: 类型名称<br>_id: 数据唯一表示符<br>_score: 得分（Elasticsearch 默认是按照文档与查询的相关度(匹配度)的得分倒序返回结果的. 得分 (_score) 就越大, 表示相关性越高.）</p>
</blockquote>
<h4 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h4><ol>
<li>全局更新（针对所有的shard做替换更新）<br>使用 put 方式，指定数据的唯一标识符（_id ）将数据的所有字段进行覆盖更新</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT http://192.168.56.130:9200/test/user/1001</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>:1001,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:<span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:21,</span><br><span class="line">  <span class="string">&quot;sex&quot;</span>:<span class="string">&quot;女&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/dEQOLYnUtmlPJ4H.png"
                      alt="elasticsearch-13.png"
                ></p>
<p>从 elasticsearch-head 数据浏览中查看到 1001 的数据已经更新</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/RMe3Il8cDwdnfB6.png"
                      alt="elasticsearch-14.png"
                ></p>
<ol start="2">
<li>局部更新（针对一个 shard 做替换更新）<br>局部更新的步骤：</li>
</ol>
<ul>
<li>从旧的文档中索引 json</li>
<li>修改并生成新的文档</li>
<li>删除旧文档</li>
<li>索引新文档</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/test/user/1001/_update</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;doc&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;age&quot;</span>:23</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/zdtFhMDfv5QAaLn.png"
                      alt="elasticsearch-15.png"
                ></p>
<p>从 elasticsearch-head 数据浏览中查看到 1001 的数据已经更新</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/ODsVyuL94T8RfoK.png"
                      alt="elasticsearch-16.png"
                ></p>
<h4 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE http://192.168.56.130:9200/test/user/1001</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/hLWQ24PIxeqkRdu.png"
                      alt="elasticsearch-17.png"
                ></p>
<p>从 elasticsearch-head 数据浏览中查看到 1001 的数据已经删除</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/U1YCsruPz9JftOX.png"
                      alt="elasticsearch-18.png"
                ></p>
<p>PS：删除一个文档不会立即从磁盘上删除，它只是被标记为已删除。随着你不断的索引更多的数据，Elasticsearch 将会在后台清理标记为已删除的文档。</p>
<h4 id="搜索数据"><a href="#搜索数据" class="headerlink" title="搜索数据"></a>搜索数据</h4><ol>
<li>查询指定的数据</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.56.130:9200/test/user/1001/5v3SJnIBH8ee6g0kq3Vy</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/nwTaWqptKO8VJdS.png"
                      alt="elasticsearch-19.png"
                ></p>
<ol start="2">
<li>查询所有数据（默认指显示10条）</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.56.130:9200/test/user/1001/_search</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/18/4pyCGdnlDLo5wm7.png"
                      alt="elasticsearch-20.png"
                ></p>
<ol start="3">
<li>关键字查询（查询age&#x3D;20的数据）</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.56.130:9200/test/user/1001/?q=age:20</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/19/uM2siayFzcGTUEr.png"
                      alt="elasticsearch-21.png"
                ></p>
<h4 id="DLS搜索"><a href="#DLS搜索" class="headerlink" title="DLS搜索"></a>DLS搜索</h4><p>提前先新建数据<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/21/1eQDfwbXBCjWSr4.png"
                      alt="elasticsearch-22.png"
                ></p>
<ol>
<li>简单查询</li>
</ol>
<p>查询年龄为 20 的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST http://192.168.56.130:9200/test/user/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;          <span class="comment">#使用 query 查询</span></span><br><span class="line">    <span class="string">&quot;match&quot;</span>:&#123;       <span class="comment">#使用 match 匹配要查询的数据</span></span><br><span class="line">      <span class="string">&quot;age&quot;</span>:20        <span class="comment">#匹配 &quot;age=20&quot; 的数据</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/21/ogfFwH6VAlyKTYe.png"
                      alt="elasticsearch-23.png"
                ></p>
<ol start="2">
<li>复杂查询</li>
</ol>
<p>查询年龄大于 20 ，且性别为男的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/test/user/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;bool&quot;</span>:&#123;     <span class="comment">#合并多个查询条件</span></span><br><span class="line">  <span class="string">&quot;filter&quot;</span>:&#123;      <span class="comment">#过滤条件</span></span><br><span class="line">    <span class="string">&quot;range&quot;</span>:&#123;     <span class="comment">#查询某个范围内的文档</span></span><br><span class="line">      <span class="string">&quot;age&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;gt&quot;</span>:30     <span class="comment">#查询 age 大于 30 的数据</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">    <span class="string">&quot;must&quot;</span>:&#123;      <span class="comment">#匹配条件</span></span><br><span class="line">      <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;sex&quot;</span>:<span class="string">&quot;男&quot;</span>     <span class="comment">#匹配 sex 为男的数据</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/21/ulgG7is4YH3Zzf9.png"
                      alt="elasticsearch-24.png"
                ></p>
<ol start="3">
<li>针对关键字进行全局搜索</li>
</ol>
<p>查询 name 为 “张三”“李四”的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST http://192.168.56.130:9200/test/user/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>:<span class="string">&quot;张三 李四&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/21/e5ghE2MCmDfZO19.png"
                      alt="elasticsearch-25.png"
                ></p>
<h4 id="高亮显示"><a href="#高亮显示" class="headerlink" title="高亮显示"></a>高亮显示</h4><p>对 “张三”“李四”数据的 name 字段进行高亮显示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST http://192.168.56.130:9200/test/user/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>:<span class="string">&quot;张三 李四&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;highlight&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/21/Iy6uxKQjD89YsWU.png"
                      alt="elasticsearch-26.png"
                ></p>
<h4 id="聚合（相当于数据库的-group-by-操作）"><a href="#聚合（相当于数据库的-group-by-操作）" class="headerlink" title="聚合（相当于数据库的 group by 操作）"></a>聚合（相当于数据库的 group by 操作）</h4><p>以 age 做一个聚合</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/test/user/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;all_interests&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/21/EgPZTouXC1A9HSm.png"
                      alt="elasticsearch-27.png"
                ></p>
<h3 id="Elasticsearch-核心内容"><a href="#Elasticsearch-核心内容" class="headerlink" title="Elasticsearch 核心内容"></a>Elasticsearch 核心内容</h3><h4 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h4><p>metadata（元数据）</p>
<table>
<thead>
<tr>
<th align="center">节点</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">_index</td>
<td align="center">文档存储的地方，在哪个 index 中</td>
</tr>
<tr>
<td align="center">_type</td>
<td align="center">文档代表的对象类，在哪个 type 中</td>
</tr>
<tr>
<td align="center">_id</td>
<td align="center">文档的唯一标识</td>
</tr>
</tbody></table>
<h4 id="查询响应"><a href="#查询响应" class="headerlink" title="查询响应"></a>查询响应</h4><ol>
<li>pretty<br>在不使用工具的时候不易阅读输出的数据，如下图所示：</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/3shrLj4bgKwzCmY.png"
                      alt="elasticsearch-28.png"
                ></p>
<p>使用  ”?pretty“ 参数对输出进行优化，如下图所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/y3ORoEIxkViC8hr.png"
                      alt="elasticsearch-29.png"
                ></p>
<ol start="2">
<li>字段响应<br>在搜索过程中都是对整个数据进行搜索。但是在查询过程中需要对数据中的某些字段进行查看，这里就需要使用字段响应。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET  http://192.168.56.130:9200/test/user/6P2QMnIBH8ee6g0kbXVq/_source?_source=<span class="built_in">id</span>,name</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/SqFZBJeTw1p7MW8.png"
                      alt="elasticsearch-30.png"
                ></p>
<h4 id="判断文档是否存在"><a href="#判断文档是否存在" class="headerlink" title="判断文档是否存在"></a>判断文档是否存在</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HEAD  http<span class="punctuation">:</span><span class="comment">//192.168.56.130:9200/test/user/8f0oNnIBH8ee6g0kB3Vw</span></span><br></pre></td></tr></table></figure>

<h4 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h4><h5 id="批量查询"><a href="#批量查询" class="headerlink" title="批量查询"></a>批量查询</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/test/user/_mget</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;ids&quot;</span>:[<span class="string">&quot;5v3SJnIBH8ee6g0kq3Vy&quot;</span>,<span class="string">&quot;6P2QMnIBH8ee6g0kbXVq&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/rg3nJaQblNR2xUf.png"
                      alt="elasticsearch-31.png"
                ></p>
<h5 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/test/user/_bulk</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;_id&quot;</span>:2001&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:2001,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name1&quot;</span>,<span class="string">&quot;age&quot;</span>:20,<span class="string">&quot;sex&quot;</span>:<span class="string">&quot;男&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;_id&quot;</span>:2002&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:2002,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name2&quot;</span>,<span class="string">&quot;age&quot;</span>:20,<span class="string">&quot;sex&quot;</span>:<span class="string">&quot;女&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;_id&quot;</span>:2003&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:2003,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name3&quot;</span>,<span class="string">&quot;age&quot;</span>:25,<span class="string">&quot;sex&quot;</span>:<span class="string">&quot;男&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/AUaZM7qdcyXtYPk.png"
                      alt="elasticsearch-32.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/uXd1KN9SWoEi4yM.png"
                      alt="elasticsearch-33.png"
                ></p>
<blockquote>
<p>最后一行必须有回车行</p>
</blockquote>
<h5 id="批量更新"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/test/user/_bulk</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;update&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;_id&quot;</span>:2001&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;doc&quot;</span>:&#123;<span class="string">&quot;id&quot;</span>:1&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;update&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;_id&quot;</span>:2002&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;doc&quot;</span>:&#123;<span class="string">&quot;id&quot;</span>:2&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;update&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;_id&quot;</span>:2003&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;doc&quot;</span>:&#123;<span class="string">&quot;id&quot;</span>:3&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/kiNTvpPF4hX3IRf.png"
                      alt="elasticsearch-34.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/JCIV4f8beaAuKPs.png"
                      alt="elasticsearch-35.png"
                ></p>
<ol start="4">
<li>批量删除</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/test/user/_bulk</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;delete&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;_id&quot;</span>:2001&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;delete&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;_id&quot;</span>:2002&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;delete&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;_id&quot;</span>:2003&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/MpkL4ls2WSA51Ca.png"
                      alt="elasticsearch-36.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/raVPZLURcK3z1Qy.png"
                      alt="elasticsearch-37.png"
                ></p>
<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><p>elasticsearch 接受 from 和 size 参数</p>
<ul>
<li>size：需要搜索数据量，默认是搜索 10 条数据</li>
<li>from：跳过开始的结果数，默认是0</li>
</ul>
<ol>
<li>从第一条数据开始，搜索一条数据</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.56.130:9200/test/user/_search?size=1</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/7QlpS3X24C8ZWHB.png"
                      alt="elasticsearch-38.png"
                ></p>
<ol start="2">
<li>从第二条数据开始，搜索一条数据</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.56.130:9200/test/user/_search?size=1&amp;from=1</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/USMa8r1Zx35qA2n.png"
                      alt="elasticsearch-39.png"
                ></p>
<h4 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h4><p>elasticsearch 会进行自动判断类型，但是有些时候我们需要进行明确字段的类型烦人，否则，自动判断的类型和实际需求是不相符合的。</p>
<p>自动判断规则如下：</p>
<table>
<thead>
<tr>
<th align="center">JSON type</th>
<th align="center">Field type</th>
</tr>
</thead>
<tbody><tr>
<td align="center">布尔值：true 和 false</td>
<td align="center">boolean</td>
</tr>
<tr>
<td align="center">整数：123</td>
<td align="center">long</td>
</tr>
<tr>
<td align="center">小数：123.45</td>
<td align="center">double</td>
</tr>
<tr>
<td align="center">时间：”2020-05-24”</td>
<td align="center">date</td>
</tr>
<tr>
<td align="center">字符串：”abc”</td>
<td align="center">string</td>
</tr>
</tbody></table>
<p>elasticsearch 中支持的类型：</p>
<table>
<thead>
<tr>
<th align="center">类型</th>
<th align="center">表示的数据类型</th>
</tr>
</thead>
<tbody><tr>
<td align="center">String</td>
<td align="center">text，keyword</td>
</tr>
<tr>
<td align="center">Whole number</td>
<td align="center">byte，short，integer，long</td>
</tr>
<tr>
<td align="center">Floating point</td>
<td align="center">float，double</td>
</tr>
<tr>
<td align="center">Boolean</td>
<td align="center">boolean</td>
</tr>
<tr>
<td align="center">Date</td>
<td align="center">date</td>
</tr>
</tbody></table>
<blockquote>
<p>keyword 类型无法分词</p>
</blockquote>
<h5 id="创建明确类型的索引"><a href="#创建明确类型的索引" class="headerlink" title="创建明确类型的索引"></a>创建明确类型的索引</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PUT http<span class="punctuation">:</span><span class="comment">//192.168.56.130:9200/itcast</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span><span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span><span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;mail&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hobby&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/CgY5wFq6IaVxLKs.png"
                      alt="elasticsearch-40.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/cAYxdGNlSX6rhyE.png"
                      alt="elasticsearch-41.png"
                ></p>
<h5 id="查看映射（-mapping）"><a href="#查看映射（-mapping）" class="headerlink" title="查看映射（ mapping）"></a>查看映射（ mapping）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.56.130:9200/itcast/_mapping</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/KBxzlmPDMO9TZHy.png"
                      alt="elasticsearch-42.png"
                ></p>
<h5 id="插入数据-1"><a href="#插入数据-1" class="headerlink" title="插入数据"></a>插入数据</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST http://192.168.56.130:9200/itcast/_bulk</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;itcast&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;_doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;张三&quot;</span>,<span class="string">&quot;age&quot;</span>:20,<span class="string">&quot;mail&quot;</span>:<span class="string">&quot;1@qq.com&quot;</span>,<span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;羽毛球、乒乓球、足球&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;itcast&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;_doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;李四&quot;</span>,<span class="string">&quot;age&quot;</span>:21,<span class="string">&quot;mail&quot;</span>:<span class="string">&quot;2@qq.com&quot;</span>,<span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;羽毛球、乒乓球、足球、篮球&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;itcast&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;_doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;王五&quot;</span>,<span class="string">&quot;age&quot;</span>:22,<span class="string">&quot;mail&quot;</span>:<span class="string">&quot;3@qq.com&quot;</span>,<span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;羽毛球、游泳、篮球、听音乐&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;itcast&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;_doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;赵六&quot;</span>,<span class="string">&quot;age&quot;</span>:23,<span class="string">&quot;mail&quot;</span>:<span class="string">&quot;4@qq.com&quot;</span>,<span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;跑步、游泳&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;itcast&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;_doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;孙七&quot;</span>,<span class="string">&quot;age&quot;</span>:24,<span class="string">&quot;mail&quot;</span>:<span class="string">&quot;5@qq.com&quot;</span>,<span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;听音乐、看电影&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/xckIMpgyjXlFmRS.png"
                      alt="elasticsearch-43.png"
                ></p>
<p>PS：在 elasticsearch 中，mapping 不能指定多个 _type 所以这里指定为默认 _type（_doc）</p>
<h5 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST http://192.168.56.130:9200/itcast/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;hobby&quot;</span>: <span class="string">&quot;音乐&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/Jeqi29jKI5OSyLb.png"
                      alt="elasticsearch-44.png"
                ></p>
<h4 id="结构化查询"><a href="#结构化查询" class="headerlink" title="结构化查询"></a>结构化查询</h4><h5 id="term-查询"><a href="#term-查询" class="headerlink" title="term 查询"></a>term 查询</h5><p>term 主要用于精确匹配数值，比如数字，日期，布尔值或 not_analyzed 的字符串</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/itcast/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: 20</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/ej9nT2Pr1lbdwX4.png"
                      alt="elasticsearch-45.png"
                ></p>
<h5 id="terms-查询"><a href="#terms-查询" class="headerlink" title="terms 查询"></a>terms 查询</h5><p>terms 和 term 有些类似，但是 terms 允许制定多个匹配条件，如果某个字段指定了多个值，那么文档需要一起去做匹配</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/itcast/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;terms&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: [20,21,22]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/rs6T9E2nXD4hVzM.png"
                      alt="elasticsearch-46.png"
                ></p>
<h5 id="range-查询"><a href="#range-查询" class="headerlink" title="range 查询"></a>range 查询</h5><p>range 过滤 允许按照指定范围查找一批数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/itcast/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">  	<span class="string">&quot;range&quot;</span>:&#123;</span><br><span class="line">    	<span class="string">&quot;age&quot;</span>:&#123;</span><br><span class="line">      		<span class="string">&quot;gte&quot;</span>: 20,</span><br><span class="line">      		<span class="string">&quot;lt&quot;</span>: 30</span><br><span class="line">		&#125;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/NvLMUjaOdyHEbgR.png"
                      alt="elasticsearch-47.png"
                ></p>
<p>范围操作符包含：</p>
<ul>
<li>gt：大于</li>
<li>gte：大于等于</li>
<li>lt：小于</li>
<li>lte：小于等于</li>
</ul>
<h5 id="exists-查询"><a href="#exists-查询" class="headerlink" title="exists 查询"></a>exists 查询</h5><p>exists 查询可以用于查找文档中是否包含了指定字段或没有某个字段，类似于 SQL 语句中的 IS_NULL 条件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POSt  http://192.168.56.130:9200/itcast/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">  	<span class="string">&quot;exists&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/MCe1JlEFbivnBaQ.png"
                      alt="elasticsearch-48.png"
                ></p>
<h5 id="match-查询"><a href="#match-查询" class="headerlink" title="match 查询"></a>match 查询</h5><p>match 查询是一个标准查询，不管你需要全文本查询还是精确查询基本上都要用到它。</p>
<p>如果使用 match 查询一个文本字段，它会先分词，然后再匹配。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST   http://192.168.56.130:9200/itcast/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">  	<span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/7ypo3JA6neMGBuC.png"
                      alt="elasticsearch-50.png"
                ></p>
<p>如果 match 查询一个数字、日期、布尔值等，它会根据匹配的数值进行搜索</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST   http://192.168.56.130:9200/itcast/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">  	<span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: 20</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/SNzawCuI7AVqD3Z.png"
                      alt="elasticsearch-49.png"
                ></p>
<h5 id="bool-查询"><a href="#bool-查询" class="headerlink" title="bool 查询"></a>bool 查询</h5><p>bool 查询可以用来合并多个条件进行数据查询，它包含以下操作符：</p>
<ul>
<li>must：多个查询条件的完全匹配，相当于 and</li>
<li>must_not：多个查询条件相反匹配，相当于 not</li>
<li>should：至少有一个查询条件匹配，相当于 or</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/itcast/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">  	<span class="string">&quot;bool&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;羽毛球&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;听音乐&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/bincRvgU59BWDx1.png"
                      alt="elasticsearch-51.png"
                ></p>
<h5 id="过滤查询"><a href="#过滤查询" class="headerlink" title="过滤查询"></a>过滤查询</h5><p>elasticsearch 也支持过滤查询，如term、range、match等</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POSt  http://192.168.56.130:9200/itcast/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">  	<span class="string">&quot;bool&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;age&quot;</span>:20</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/dshEuFQ63gIvri2.png"
                      alt="elasticsearch-52.png"
                ></p>
<p>过滤查询和匹配查询的区别：</p>
<ul>
<li>一条过滤语句会询问每个文档的字段值是否包含着特定值</li>
<li>查询语句会询问每个文档的字段值和特定值的匹配程度如何<ul>
<li>一条查询语句会计算每个文档与查询语句的相关性，并给出评分 _score，并且按照 _score 的值对匹配到的文档进行排序。这种评分方式非常适用于一个没有完全配置结果的全文搜索</li>
</ul>
</li>
<li>过滤特定值时会将相关文档的列表缓存到内存当中，这样后续查询会更加高效</li>
</ul>
<blockquote>
<p>总的来说就是：匹配查询消耗的性能比较大，所以一般来说查询语句比过滤语句更耗时，并且查询结果不可缓存。</p>
</blockquote>
<h4 id="中文分词"><a href="#中文分词" class="headerlink" title="中文分词"></a>中文分词</h4><h5 id="什么是分词"><a href="#什么是分词" class="headerlink" title="什么是分词"></a>什么是分词</h5><p>分词就是将一个文本转化成一系列单词的过程，也叫文本分析，在 elasticsearch 中称之为 Analysis。</p>
<p>举例：我是中国人 –&gt; 我&#x2F;是&#x2F;中国人</p>
<h5 id="分词-api"><a href="#分词-api" class="headerlink" title="分词 api"></a>分词 api</h5><p>指定分词器进行分词</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/_analyze</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>:<span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;Hello World&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/ynvYQ68bB3Pe9iX.png"
                      alt="elasticsearch-53.png"
                ></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/_analyze</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>:<span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;我是中国人&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/vGExVmlpJW2UsD7.png"
                      alt="elasticsearch-54.png"
                ></p>
<h5 id="中文分词-1"><a href="#中文分词-1" class="headerlink" title="中文分词"></a>中文分词</h5><p>中文分词的难点在于，在汉语中没有明显的词汇分界点，如果在英语中，空格可以作为分隔符。中文分词中如果分隔符不正确就会造成歧义。</p>
<p>如：<br>我&#x2F;爱&#x2F;炒肉丝<br>我&#x2F;爱&#x2F;炒&#x2F;肉丝</p>
<p>常用中文分词器，IK、jieba、THULAC等，推荐使用 IK 分词器</p>
<ol>
<li>安装 ik 分词器（下载相应的版本）<br>下载 <a class="link"   target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik" >elasticsearch-analysis-ik<i class="fas fa-external-link-alt"></i></a></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@promote ~]<span class="comment">#  mkdir /usr/share/elasticsearch/plugins/ik</span></span><br><span class="line">[root@promote ~]<span class="comment"># /usr/share/elasticsearch/bin/elasticsearch-plugin install file:///root/elasticsearch-analysis-ik-7.6.2.zip</span></span><br><span class="line">-&gt; Installing file:///root/elasticsearch-analysis-ik-7.6.2.zip</span><br><span class="line">-&gt; Downloading file:///root/elasticsearch-analysis-ik-7.6.2.zip</span><br><span class="line">[=================================================] 100%  </span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">@     WARNING: plugin requires additional permissions     @</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">* java.net.SocketPermission * connect,resolve</span><br><span class="line">See http://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html</span><br><span class="line"><span class="keyword">for</span> descriptions of what these permissions allow and the associated risks.</span><br><span class="line"></span><br><span class="line">Continue with installation? [y/N]y</span><br><span class="line">-&gt; Installed analysis-ik</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>重启 elasticsearch 服务</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@promote ~]<span class="comment">#  systemctl restart elasticsearch</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>分词</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/_analyze</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>:<span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;我是中国人&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/05/27/TMx6mjYsbOSVhX3.png"
                      alt="elasticsearch-55.png"
                ></p>
<h4 id="全文搜索"><a href="#全文搜索" class="headerlink" title="全文搜索"></a>全文搜索</h4><p>全文搜索有两个最重要的方面是：</p>
<ul>
<li>相关性（Relevance）它是评价查询与其结果的 相关程度，并根据这种相关程度对结果排名的一种能力，这种计算方式可以是 TF&#x2F;IDE 方法、地理位置临近、模糊相似，或其他的某些算法。</li>
<li>分词（Analysis） 它是将文本块转换为有区别的、规范化的 token 的一个过程，目的是为了创建倒排索引以及查询倒排索引。</li>
</ul>
<h5 id="构造数据"><a href="#构造数据" class="headerlink" title="构造数据"></a>构造数据</h5><ol>
<li>创建分词索引</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT   http://192.168.56.130:9200/fenci</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span>:<span class="string">&quot;0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>:&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;age&quot;</span>:&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;mail&quot;</span>:&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;hobby&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>:<span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/01/kapV7QvycZS9jXY.png"
                      alt="elasticsearch-56.png"
                ></p>
<blockquote>
<p>如果是多个 elasticsearch 节点中，每个节点都要安装 analysis-ik 分词器。否则创建索引会出现如下报错：<code>&quot;shards_acknowledged&quot;: flase</code></p>
</blockquote>
<ol start="2">
<li>创建数据</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/fenci/_bulk</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;fenci&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;_doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;张三&quot;</span>,<span class="string">&quot;age&quot;</span>:20,<span class="string">&quot;mail&quot;</span>:<span class="string">&quot;1@qq.com&quot;</span>,<span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;羽毛球、乒乓球、足球&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;fenci&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;_doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;李四&quot;</span>,<span class="string">&quot;age&quot;</span>:21,<span class="string">&quot;mail&quot;</span>:<span class="string">&quot;2@qq.com&quot;</span>,<span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;羽毛球、乒乓球、足球、篮球&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;fenci&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;_doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;王五&quot;</span>,<span class="string">&quot;age&quot;</span>:22,<span class="string">&quot;mail&quot;</span>:<span class="string">&quot;3@qq.com&quot;</span>,<span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;羽毛球、游泳、篮球、听音乐&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;fenci&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;_doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;赵六&quot;</span>,<span class="string">&quot;age&quot;</span>:23,<span class="string">&quot;mail&quot;</span>:<span class="string">&quot;4@qq.com&quot;</span>,<span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;跑步、游泳、篮球&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;fenci&quot;</span>,<span class="string">&quot;_type&quot;</span>:<span class="string">&quot;_doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;孙七&quot;</span>,<span class="string">&quot;age&quot;</span>:24,<span class="string">&quot;mail&quot;</span>:<span class="string">&quot;5@qq.com&quot;</span>,<span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;听音乐、看电影、羽毛球&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/01/2X5aE8FwbrP9qu6.png"
                      alt="elasticsearch-57.png"
                ></p>
<h5 id="单词搜索"><a href="#单词搜索" class="headerlink" title="单词搜索"></a>单词搜索</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/fenci/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;音乐&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">  	&#125;,</span><br><span class="line">  <span class="string">&quot;highlight&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;hobby&quot;</span>:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/01/G79wXe4EHlInS3T.png"
                      alt="elasticsearch-58.png"
                ></p>
<p>分词过程：</p>
<ol>
<li><p>检查字段类型<br>hobby 字段是一个 text 类型（指定了 IK 分词器），这意味着查询字符串本身也应该被分词</p>
</li>
<li><p>分析查询字符串<br>将查询的字符串“音乐”传入 IK 分词器中，输出的结果是单个项，所以 match 查询执行的是单个底层 term 查询。</p>
</li>
<li><p>查找匹配文档<br>用 term 查询在倒排索引中查找“音乐”然后取一组包含该项的文档。</p>
</li>
<li><p>为每个文档评分<br>用 term 查询计算每个文档相关度评分 _source ，这是一种将 词频（term frequency，即词“音乐”在相关文档的 hobby 字段中出现的频率）和反向文档频率（inverse document frequency，即词 “音乐”在所有文档的 hobby 字段中出现的频率），以及字段的长度（即字段越短相关度越高）相结合的计算方式。</p>
</li>
</ol>
<h5 id="多词搜索"><a href="#多词搜索" class="headerlink" title="多词搜索"></a>多词搜索</h5><ol>
<li>使用 OR 逻辑，进行多词搜索</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/fenci/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;音乐 篮球&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">  	&#125;,</span><br><span class="line">  <span class="string">&quot;highlight&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;hobby&quot;</span>:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/01/rf2DRzNAEXuwygJ.png"
                      alt="elasticsearch-59.png"
                ></p>
<ol start="2">
<li>使用 AND 逻辑，进行多词搜索</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/fenci/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;operator&quot;</span>:<span class="string">&quot;and&quot;</span>,</span><br><span class="line">            <span class="string">&quot;query&quot;</span>:<span class="string">&quot;音乐 篮球&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  	&#125;,</span><br><span class="line">  <span class="string">&quot;highlight&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;hobby&quot;</span>:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/01/mv6kca7FRdNUhQn.png"
                      alt="elasticsearch-60.png"
                ></p>
<ol start="3">
<li>使用匹配度进行多词查询</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/fenci/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;minimum_should_match&quot;</span>:<span class="string">&quot;80%&quot;</span>,</span><br><span class="line">            <span class="string">&quot;query&quot;</span>:<span class="string">&quot;游泳、羽毛球&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  	&#125;,</span><br><span class="line">  <span class="string">&quot;highlight&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;hobby&quot;</span>:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/01/cUptBzrvYM5Imb4.png"
                      alt="elasticsearch-61.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/01/IzX9dE1OMpfLPAj.png"
                      alt="elasticsearch-62.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/01/su4N9U3OqVAcxCZ.png"
                      alt="elasticsearch-63.png"
                ></p>
<h5 id="组合搜索"><a href="#组合搜索" class="headerlink" title="组合搜索"></a>组合搜索</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/fenci/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">  	<span class="string">&quot;bool&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;篮球&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;音乐&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;should&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;游泳&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">      <span class="string">&quot;highlight&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;fields&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/01/bjifute2FlnhTOc.png"
                      alt="elasticsearch-64.png"
                ></p>
<blockquote>
<p>上面搜索的意思是：搜索结果中必须包含篮球、不能包含音乐，如果包含了游泳，那么它的相似度更高</p>
</blockquote>
<blockquote>
<p>评分计算规则：<br>bool 查询会为每个文档计算相关评分 _score，再将所有匹配的 must 和 should 语句的分数 _score 求和，最后除以 must 和 should 语句的总数。<br>must_not 语句不会影响评分，它的作用只是将不相关的文档排除。</p>
</blockquote>
<p>默认情况下，should 中的内容不是必须匹配的，如果查询语句中没有 must，那么就会至少匹配其中一个。当然也可以通过 <code>minimum_should_match</code> 参数进行控制，该值可以是数字或百分比。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/fenci/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">  	<span class="string">&quot;bool&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;should&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;游泳&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;篮球&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:<span class="string">&quot;音乐&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;minimum_should_match&quot;</span>:2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">      <span class="string">&quot;highlight&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;fields&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/01/jpZa24zKhodkNe9.png"
                      alt="elasticsearch-65.png"
                ></p>
<h5 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h5><p>有些时候，我们可能需要对某些词增加权重来影响该条数据的得分。如下：</p>
<blockquote>
<p>搜索关键字为“游泳篮球”，如果结果中包含了“音乐”权重为 10，包含了“跑步”权重为2</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">POST  http://192.168.56.130:9200/fenci/_doc/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">  	<span class="string">&quot;bool&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:&#123;</span><br><span class="line">              <span class="string">&quot;query&quot;</span>:<span class="string">&quot;游泳篮球&quot;</span>,</span><br><span class="line">              <span class="string">&quot;operator&quot;</span>:<span class="string">&quot;and&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;should&quot;</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:&#123;</span><br><span class="line">              <span class="string">&quot;query&quot;</span>:<span class="string">&quot;音乐&quot;</span>,</span><br><span class="line">              <span class="string">&quot;boost&quot;</span>:10</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:&#123;</span><br><span class="line">              <span class="string">&quot;query&quot;</span>:<span class="string">&quot;跑步&quot;</span>,</span><br><span class="line">              <span class="string">&quot;boost&quot;</span>:2</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     ]</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br><span class="line">      <span class="string">&quot;highlight&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;fields&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;hobby&quot;</span>:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/01/NcbTJdGiFf8zW5s.png"
                      alt="elasticsearch-66.png"
                ></p>
<h2 id="elasticsearch-集群"><a href="#elasticsearch-集群" class="headerlink" title="elasticsearch 集群"></a>elasticsearch 集群</h2><h3 id="elasticsearch-集群搭建"><a href="#elasticsearch-集群搭建" class="headerlink" title="elasticsearch 集群搭建"></a>elasticsearch 集群搭建</h3><ol>
<li>创建 3 人台虚拟机，下载并安装 JAVA 和  <a class="link"   target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch" >Elasticsearch<i class="fas fa-external-link-alt"></i></a></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@promote ~]<span class="comment"># yum -y install java</span></span><br><span class="line">[root@promote ~]<span class="comment"># rpm -ivh elasticsearch-7.6.2-x86_64.rpm</span></span><br><span class="line">[root@promote ~]<span class="comment"># systemctl stop firewalld</span></span><br><span class="line">[root@promote ~]<span class="comment"># systemctl disable firewalld</span></span><br><span class="line">[root@promote ~]<span class="comment"># setenforce 0</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 elasticsearch</li>
</ol>
<ul>
<li>node01</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@promote ~]<span class="comment"># cat /etc/elasticsearch/elasticsearch.yml | grep -v ^#</span></span><br><span class="line">cluster.name: My_Cluster                <span class="comment"># 集群名称</span></span><br><span class="line">node.name: node01                       <span class="comment"># 节点名称</span></span><br><span class="line">node.master: <span class="literal">true</span>                       <span class="comment"># 允许该节点成为为 master 节点</span></span><br><span class="line">node.data: <span class="literal">true</span>                         <span class="comment"># 允许该节点成为 data 节点</span></span><br><span class="line">path.data: /var/lib/elasticsearch       <span class="comment"># 数据存储位置</span></span><br><span class="line">path.logs: /var/log/elasticsearch       <span class="comment"># 日志存储路径</span></span><br><span class="line">network.host: 0.0.0.0                   <span class="comment"># 监听地址</span></span><br><span class="line">http.port: 9200                         <span class="comment"># 监听端口</span></span><br><span class="line"></span><br><span class="line">discovery.zen.minimum_master_nodes: 2   <span class="comment"># master 候选节点数，【计算公式：N（节点数）/2+1】</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">&quot;192.168.56.130&quot;</span>, <span class="string">&quot;192.168.56.131&quot;</span>, <span class="string">&quot;192.168.56.132&quot;</span>] <span class="comment"># elasticsearch 节点地址</span></span><br><span class="line"></span><br><span class="line">http.cors.enabled: <span class="literal">true</span></span><br><span class="line">http.cors.allow-origin: <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>discovery.zen.minimum_master_nodes: 2 的意思是：每两个 node 分为一组，然后进行 master 节点选举。剩下的 1 个 node 不能组成一组，没有权限进行 master 选举。</p>
</blockquote>
<ul>
<li>node02</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@promote ~]<span class="comment"># cat /etc/elasticsearch/elasticsearch.yml | grep -v ^#</span></span><br><span class="line">cluster.name: My_Cluster</span><br><span class="line">node.name: node02</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/log/elasticsearch</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line"></span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">&quot;192.168.56.130&quot;</span>, <span class="string">&quot;192.168.56.131&quot;</span>, <span class="string">&quot;192.168.56.132&quot;</span>]</span><br><span class="line"></span><br><span class="line">http.cors.enabled: <span class="literal">true</span></span><br><span class="line">http.cors.allow-origin: <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>node03</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@promote ~]<span class="comment"># cat /etc/elasticsearch/elasticsearch.yml | grep -v ^#</span></span><br><span class="line">cluster.name: My_Cluster</span><br><span class="line">node.name: node03</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/log/elasticsearch</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line"></span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">&quot;192.168.56.130&quot;</span>, <span class="string">&quot;192.168.56.131&quot;</span>, <span class="string">&quot;192.168.56.132&quot;</span>]</span><br><span class="line"></span><br><span class="line">http.cors.enabled: <span class="literal">true</span></span><br><span class="line">http.cors.allow-origin: <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动 elasticsearch<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@promote ~]<span class="comment"># systemctl start elasticsearch</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/M8E9hUAeGVygQWw.png"
                      alt="elasticsearch-67.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/WYPmgwjVKEq9T8U.png"
                      alt="elasticsearch-68.png"
                ></p>
<blockquote>
<p>线条粗的是主分片，线条细的是副本分片；节点前面是“五角星”说明该节点是主节点，节点前面是“圆形”说明该节点是数据节点。</p>
</blockquote>
<h3 id="集群的故障转移"><a href="#集群的故障转移" class="headerlink" title="集群的故障转移"></a>集群的故障转移</h3><blockquote>
<p>将 node01 节点关闭，从上图中可以看到 node03 自动切换为主节点。 itcast 索引中 “0”的主分片有问题，因此集群显示为“红色”。因为 itcast 索引没有副本分片，所以导致 itcast 的主分片无法进行故障转移。</p>
</blockquote>
<p>如果在配置文件中 discovery.zen.minimum_master_nodes 设置的值不是 N&#x2F;2+1 时，会出现脑裂问题，之前宕机的主节点不会加入到集群。</p>
<p>比如现在<code>discovery.zen.minimum_master_nodes=1</code>，集群就会出现下面的状况：</p>
<table>
<thead>
<tr>
<th align="center">集群节点</th>
<th align="center">运行状态</th>
</tr>
</thead>
<tbody><tr>
<td align="center">node01（M） ; node02 ; node03</td>
<td align="center">正常状态</td>
</tr>
<tr>
<td align="center">node01（M）；node02<font color=red>（M） </font> ; node03</td>
<td align="center">node01 宕机，node02 变为主节点</td>
</tr>
<tr>
<td align="center">node01<font color=red>（M） </font>；node02<font color=red>（M） </font> ; node03</td>
<td align="center">node01 恢复，node01 和 node02 都变为主节点，即脑裂问题</td>
</tr>
</tbody></table>
<blockquote>
<ul>
<li>当 node01 宕机后，集群重新选举主节点，此时 node02 变成了主节点</li>
<li>当 node01 恢复后，因为 minimum_master_nodes 为 1 ，简单来说就是 1 个节点分为一组进行 master选举。也就是 node01 进行 master 节点选举，此时 node01 会变成主节点。</li>
<li>现在集群中出现了 2 个主节点，而一个集群中只能存在一个主节点，所以 node01 就不会加入到集群中。</li>
<li>一个集群中因为某些原因出现多个主节点的现象，被称为脑裂问题</li>
</ul>
</blockquote>
<h3 id="分布式文档"><a href="#分布式文档" class="headerlink" title="分布式文档"></a>分布式文档</h3><h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><p>在 elasticsearch 中，文档存储在哪个节点是由下面的计算公式来确定的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shard = <span class="built_in">hash</span>（Routing）% number_of_primary_shards</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>routing 值是一个任意字符串，它默认是_id但也可以自定义</li>
<li>这个 Routing 字符串是通过哈希函数生成一个数字，然后除以主分片的数量得到一个余数（remainder），余数的范围永远是0到number_of_paimary_shards-1，这个数字就是特定文档所在的分片</li>
</ul>
</blockquote>
<p>如果修改主分片，shard 值就会发生改变，最终导致无法找到文档数据。这就是为什么创建主分片后，不能修改的原因。</p>
<h4 id="文档写操作"><a href="#文档写操作" class="headerlink" title="文档写操作"></a>文档写操作</h4><p>新建、索引】删除请求都是写（write）操作，它们必须在主分片上成功完成复制到相关副本分片上。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://www.elastic.co/guide/cn/elasticsearch/guide/current/images/elas_0401.png"
                     
                ></p>
<p>下面解释主分片和副本分片上成功新建、索引和删除一个文档必要的顺序步骤：</p>
<ol>
<li>客户端给 node 1发送新建、索引或删除请求</li>
<li>节点使用文档的_id确定文档属于 P0 。node 1 转发请求给 node 3。</li>
<li>node 3 在主分片上执行请求，如果成功，node 3 转发请求到响应位于 node 1 和node 2 的副本分片（R0）上面，当所有副本分片操作完成后，返回操作成功的信息给 node 3。最后 node 3 报告成功到请求节点（node 1），请求节点再报告给客户端。</li>
<li>客户端接受到成功响应的时候，文档修改已经被应用于主分片和所有的副本分片。你的修改已经生效。</li>
</ol>
<h4 id="文档搜索（单文档）"><a href="#文档搜索（单文档）" class="headerlink" title="文档搜索（单文档）"></a>文档搜索（单文档）</h4><p>文档能够从主分片或任意一个副本分片被检索。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://www.elastic.co/guide/cn/elasticsearch/guide/current/images/elas_0401.png"
                     
                ></p>
<p>下面解释主分片和副本分片上检索一个文档必要的顺序步骤：</p>
<ol>
<li>客户端给 node 1 发送 get 请求。</li>
<li>节点使用文档_id确定文档属于 P0。P0 在三个节点上都有，此时 node 1 转发请求给 node 2。</li>
<li>node 2 返回文档（document）给 node 1 然后返回给客户端。</li>
</ol>
<p>对于读请求，为了平衡负载，请求节点会向所有分片进行轮询访问。</p>
<p>可能会出现的情况是，一个被索引的文档已经存贮在主分片上却还没有来得及同步到副本分片上。这时副本分片就会报告文档未找到，主分片会成功返回文档。一旦索引请求成功返回给用户，文档则在主分片和副本分片上都是可用的。</p>
<h4 id="全文搜索-1"><a href="#全文搜索-1" class="headerlink" title="全文搜索"></a>全文搜索</h4><p>对于全文搜索而言，文档可能分散在各个节点上，那么在分布式的情况下，如何搜索文档呢？<br>搜索，分为 2 个阶段，搜索（query）+取回（fetch）</p>
<blockquote>
<p>搜索（query）</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://www.elastic.co/guide/cn/elasticsearch/guide/current/images/elas_0401.png"
                     
                ></p>
<p>查询阶段包含以下 3 步：</p>
<ol>
<li>客户端发送一个 search（搜索）请求给 node 3， node 3创建了一个长度为 from+size 的空有限级队列</li>
<li>node 3 转发这个搜索请求到索引中每个分片的原本和副本。每个分片在本地执行这个查询并且将结果放到一个大小为 from+size 的有序本地优先队列里去。</li>
<li>每个分片返回 document 的 ID 和它优先队列里的所有 document 的排序值给协调点 node 3。node 3 把这些值合并到自己的优先队列里并产生全局排序结果。</li>
</ol>
<blockquote>
<p>取回（fetch）</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://www.elastic.co/guide/cn/elasticsearch/guide/current/images/elas_0401.png"
                     
                ></p>
<p>取回阶段是由以下步骤构成：</p>
<ol>
<li>协调节点辨别出哪个 document 需要取回，并且向相关分片发出 GET 请求。</li>
<li>每个分片加载 document 并且根据需要丰富（enrich）它们（之前是获得文档 ID，这次是获取完整的数据），然后再将 document 返回协调节点。</li>
<li>一旦所有的 document 都被取回，协调节点会将结果返回给客户端。</li>
</ol>
<h2 id="beats-简介"><a href="#beats-简介" class="headerlink" title="beats 简介"></a>beats 简介</h2><p>Beats是 Elastic 公司开发提供的开源数据收集器集合，只需要将其端(Agent)安装到服务器上，通过简单的配置，就可以将指定的数据发送到 Elasticsearch。Elastic 提供了多种类的 Beats 用来收集不同的数据。</p>
<h3 id="filebeat-入门"><a href="#filebeat-入门" class="headerlink" title="filebeat 入门"></a>filebeat 入门</h3><p>Filebea t是一个轻量级日志传输 Agent，可以将指定日志转发到 Logstash、Elasticsearch、Kafka、Redis等中。Filebeat 占用资源少，而且安装配置也比较简单，支持目前各类主流 OS 及 Docker 平台。</p>
<h4 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h4><ol>
<li>安装 filebeat</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost beats]<span class="comment"># rpm -ivh filebeat-7.6.2-x86_64.rpm</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 filebeat 配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># cat itcast.yml</span></span><br><span class="line">filebeat.inputs:      //指定 filebeat 的输入</span><br><span class="line">- <span class="built_in">type</span>: stdin         //输入类型是标准的命令行输入（stdin）</span><br><span class="line">  enabled: <span class="literal">true</span>       //启用这个输入类型</span><br><span class="line">output.console:       //结果输出到控制台</span><br><span class="line">  pretty: <span class="literal">true</span>        //将输出格式化</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span>        //启用这个输出功能</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>执行配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># cd cd /etc/filebeat/</span></span><br><span class="line">[root@localhost filebeat]<span class="comment"># filebeat -e -c itcast.yml</span></span><br><span class="line">省略......</span><br><span class="line">hello     //输入“hello”</span><br><span class="line">&#123;         //输出结果</span><br><span class="line">  <span class="string">&quot;@timestamp&quot;</span>: <span class="string">&quot;2020-06-10T17:20:33.801Z&quot;</span>,</span><br><span class="line">  <span class="string">&quot;@metadata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;beat&quot;</span>: <span class="string">&quot;filebeat&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;7.6.2&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;ecs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.4.0&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;host&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;localhost.localdomain&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;agent&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;7.6.2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;filebeat&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ephemeral_id&quot;</span>: <span class="string">&quot;5f643804-b15c-407d-bbd3-54410711b689&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hostname&quot;</span>: <span class="string">&quot;localhost.localdomain&quot;</span>,</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;f8b298c7-50eb-4e1e-84f6-8a092ce8ec82&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;log&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;offset&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;file&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;path&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;hello&quot;</span>,   //输出的信息</span><br><span class="line">  <span class="string">&quot;input&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;stdin&quot;</span>     //输入的类型</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h4><ol>
<li>创建配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># cd cd /etc/filebeat/</span></span><br><span class="line">[root@localhost filebeat]<span class="comment"># cat itcast-log.yml</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span>   //输入类型改为 <span class="built_in">log</span></span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  paths:      //指定文件的读取路径</span><br><span class="line">    - /root/logs/*.<span class="built_in">log</span></span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">output.console:</span><br><span class="line">  pretty: <span class="literal">true</span></span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>执行配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># filebeat -e -c itcast-log.yml</span></span><br><span class="line">省略......</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;@timestamp&quot;</span>: <span class="string">&quot;2020-06-16T14:21:52.630Z&quot;</span>,</span><br><span class="line">  <span class="string">&quot;@metadata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;beat&quot;</span>: <span class="string">&quot;filebeat&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;7.6.2&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;log&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;offset&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;file&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/root/logs/a.log&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">  <span class="string">&quot;input&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;log&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;ecs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.4.0&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;host&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;localhost.localdomain&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;agent&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;ephemeral_id&quot;</span>: <span class="string">&quot;cc299970-8fd9-4239-bfa3-0500e9096b5b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hostname&quot;</span>: <span class="string">&quot;localhost.localdomain&quot;</span>,</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;f8b298c7-50eb-4e1e-84f6-8a092ce8ec82&quot;</span>,</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;7.6.2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;filebeat&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>PS: 此时向文件 a.log 追加内容，filebeat 会继续读取并输出内容</p>
</blockquote>
<h4 id="输出到-elasticsearch"><a href="#输出到-elasticsearch" class="headerlink" title="输出到 elasticsearch"></a>输出到 elasticsearch</h4><ol>
<li>创建配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># cat itcast-log.yml</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  paths:</span><br><span class="line">    - /root/logs/*.<span class="built_in">log</span></span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">&quot;192.168.56.135:9200&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>执行配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># filebeat -e -c itcast-log.yml</span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/verABy6RTGai2n9.png"
                      alt="elasticsearch-69.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/DB5oktPuh64HEeq.png"
                      alt="elasticsearch-70.png"
                ></p>
<blockquote>
<p>注意：执行命令后，需要手动向 a.log 文件中添加内容，filebeat 才会 将内容输出到 elasticsearch</p>
</blockquote>
<h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><p>filebeat 由两个主要组件组成：prospector 和 harvester</p>
<ul>
<li><p>harvester 并找到所有要读取的文件来源</p>
</li>
<li><p>负责读取单个文件的内容</p>
</li>
<li><p>如果文件在读取时被删除或重命名，Filebeat 将继续读取文件</p>
</li>
<li><p>prospector</p>
<ul>
<li>prospector 负责管理 harvester 并找到所有要读取的文件来源</li>
<li>如果输入类型为日志，则查找器将查找路径匹配的所有文件，并为每个文件启动一个 harvester。</li>
<li>Filebeat 目前支持两种 prospector 类型：log 和 stdin</li>
</ul>
</li>
<li><p>Filebeat 如何保持文件状态</p>
<ul>
<li>filebeat 保存每个文件的状态并经常将状态刷新到磁盘上的注册文件中</li>
<li>该状态用于记住  harvester 正在读取最后的偏移量，并确保发送所有日志行</li>
<li>如果输出（例如 elasticsearch 或 logstash）无法访问，filebeat 会跟踪最后发送的行，并在输出再次可用时继续读取文件</li>
<li>在 Filebeat 运行时，每个 prospector 内存中也会保存文件状态信息，当重启 Filebeat 时，将使用注册文件的数据来重建文件状态，Filebeat 将每个 harvester 在从保存的最后偏移继续读取</li>
<li>文件状态记录在 data&#x2F;registry 文件中</li>
</ul>
</li>
<li><p>filebeat 命令参数</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filebeat -e -c filename -d <span class="string">&quot;public&quot;</span></span><br><span class="line"></span><br><span class="line">-e：输出到标准输出，默认输出到 syslog 和 logs 下</span><br><span class="line">-c：指定配置文件</span><br><span class="line">-d：输出 debug 信息</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当 filebeat 将内容输出到 elasticsearch 时，可以使用该 -d 参数，从命令行中看到 filebeat 的输出内容。</p>
</blockquote>
<h4 id="读取-Nginx-日志文件"><a href="#读取-Nginx-日志文件" class="headerlink" title="读取 Nginx 日志文件"></a>读取 Nginx 日志文件</h4><ol>
<li>安装、启动 nginx</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># yum -y install nginx</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl start nginx</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># cat itcast-nginx.yml</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/*.<span class="built_in">log</span></span><br><span class="line">  tags: [<span class="string">&quot;nginx&quot;</span>]</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">&quot;192.168.56.135:9200&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>执行配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># filebeat -e -c itcast-nginx.yml</span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/RwMgNua3DSd1Y7m.png"
                      alt="elasticsearch-71.png"
                ></p>
<blockquote>
<p>PS：在执行配置文件前，最好把之前的 filebeat 索引删掉；执行配置文件后，用浏览器访问 nginx，让其产生日志信息。</p>
</blockquote>
<h4 id="Moudule-的使用"><a href="#Moudule-的使用" class="headerlink" title="Moudule 的使用"></a>Moudule 的使用</h4><ol>
<li>查看 filebeat 的 modules</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># filebeat modules list</span></span><br><span class="line">Enabled:    //已经启用的 modules</span><br><span class="line"></span><br><span class="line">Disabled:   //关闭的 modules</span><br><span class="line">activemq</span><br><span class="line">apache</span><br><span class="line">auditd</span><br><span class="line">aws</span><br><span class="line">azure</span><br><span class="line">cef</span><br><span class="line">cisco</span><br><span class="line">coredns</span><br><span class="line">elasticsearch</span><br><span class="line">envoyproxy</span><br><span class="line">googlecloud</span><br><span class="line">haproxy</span><br><span class="line">ibmmq</span><br><span class="line">icinga</span><br><span class="line">iis</span><br><span class="line">iptables</span><br><span class="line">kafka</span><br><span class="line">kibana</span><br><span class="line">logstash</span><br><span class="line">misp</span><br><span class="line">mongodb</span><br><span class="line">mssql</span><br><span class="line">mysql</span><br><span class="line">nats</span><br><span class="line">netflow</span><br><span class="line">nginx</span><br><span class="line">osquery</span><br><span class="line">panw</span><br><span class="line">postgresql</span><br><span class="line">rabbitmq</span><br><span class="line">redis</span><br><span class="line">santa</span><br><span class="line">suricata</span><br><span class="line">system</span><br><span class="line">traefik</span><br><span class="line">zeek</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>启用 nginx module</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># filebeat modules enable nginx</span></span><br><span class="line">Enabled nginx</span><br></pre></td></tr></table></figure>
<blockquote>
<p>禁用 nginx module 使用如下命令：filebeat modules disable nginx</p>
</blockquote>
<ol start="3">
<li>配置 nginx module</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cd /etc/filebeat/modules.d</span></span><br><span class="line">[root@localhost modules.d]<span class="comment"># cat nginx.yml    </span></span><br><span class="line"><span class="comment"># Module: nginx</span></span><br><span class="line"><span class="comment"># Docs: https://www.elastic.co/guide/en/beats/filebeat/7.6/filebeat-module-nginx.html</span></span><br><span class="line"></span><br><span class="line">- module: nginx</span><br><span class="line">  <span class="comment"># Access logs</span></span><br><span class="line">  access:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    var.paths: [<span class="string">&quot;/var/log/nginx/access.log*&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Error logs</span></span><br><span class="line">  error:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    var.paths: [<span class="string">&quot;/var/log/nginx/error.log*&quot;</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>modules 的配置文件路径：&#x2F;etc&#x2F;filebeat&#x2F;modules.d</p>
</blockquote>
<ol start="4">
<li>创建配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># cat itcast-nginx.yml</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line"><span class="comment">#- type: log</span></span><br><span class="line"><span class="comment">#  enabled: true</span></span><br><span class="line"><span class="comment">#  paths:</span></span><br><span class="line"><span class="comment">#    - /var/log/nginx/*.log</span></span><br><span class="line"><span class="comment">#  tags: [&quot;nginx&quot;]</span></span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">&quot;192.168.56.135:9200&quot;</span>]</span><br><span class="line">filebeat.config.modules:</span><br><span class="line">  path: <span class="variable">$&#123;path.config&#125;</span>/modules.d/*.yml</span><br><span class="line">reload.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>执行配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost filebeat]<span class="comment"># filebeat -e -c itcast-nginx.yml</span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/oP9VEL2CrWK1jaZ.png"
                      alt="elasticsearch-72.png"
                ></p>
<blockquote>
<p>PS：在执行配置文件前，最好把之前的 filebeat 索引删掉；执行配置文件后，用浏览器访问 nginx，让其产生日志信息。<br>从图片张可以看到，这次的数据都已经被处理过，使数据看的更加清晰</p>
</blockquote>
<h3 id="Metricbeat"><a href="#Metricbeat" class="headerlink" title="Metricbeat"></a>Metricbeat</h3><p>用于从系统和服务收集指标。Metricbeat 能够以一种轻量型的方式，输送各种系统和服务统计数据，从 cpu 到内存，从 Redis 到 Nginx。</p>
<ul>
<li>定期收集操作系统或应用服务的指标数据</li>
<li>存储到 Elasticsearch 中，进行实时分析</li>
</ul>
<h4 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h4><p>Metricbeat 由两部分组成，一部分是 Module，另一部分为 Metricset。</p>
<ul>
<li>Module<ul>
<li>收集对象，如：mysql、redis、nginx、操作系统等；</li>
</ul>
</li>
<li>Metricset<ul>
<li>收集指标的集合，如：cpu、memory、network等；</li>
</ul>
</li>
</ul>
<h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><ol>
<li>安装 metricbeat</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@192 beats]<span class="comment"># rpm -ivh metricbeat-7.6.2-x86_64.rpm</span></span><br><span class="line">警告：metricbeat-7.6.2-x86_64.rpm: 头V4 RSA/SHA512 Signature, 密钥 ID d88e42b4: NOKEY</span><br><span class="line">准备中...                          <span class="comment">################################# [100%]</span></span><br><span class="line">正在升级/安装...</span><br><span class="line">   1:metricbeat-7.6.2-1               <span class="comment">################################# [100%]</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 metricbeat</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@192 beats]<span class="comment"># cd /etc/metricbeat/</span></span><br><span class="line">[root@192 metricbeat]<span class="comment"># vim metricbeat.yml</span></span><br><span class="line"><span class="comment">#-------------------------- Elasticsearch output ------------------------------</span></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  <span class="comment"># Array of hosts to connect to.</span></span><br><span class="line">  hosts: [<span class="string">&quot;192.168.56.135:9200&quot;</span>]    //输入 elasticsearch 地址</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动 metricbeat</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192 metricbeat]<span class="comment"># metricbeat -e</span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/iy4ckGST1WwdIjB.png"
                      alt="elasticsearch-73.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/zugMGaHB93lkLOt.png"
                      alt="elasticsearch-74.png"
                ></p>
<h4 id="metricbeat-modules"><a href="#metricbeat-modules" class="headerlink" title="metricbeat modules"></a>metricbeat modules</h4><ol>
<li>查看 modules</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192 modules.d]<span class="comment"># metricbeat modules list</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>metricbeat modules 路径：&#x2F;etc&#x2F;metricbeat&#x2F;modules.d（默认开启了 system module）</p>
</blockquote>
<ol start="2">
<li>开启 nginx 状态查询</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@192 nginx]<span class="comment"># vim nginx.conf</span></span><br><span class="line">//在 server 中添加如下内容</span><br><span class="line">    location /nginx-status &#123;</span><br><span class="line">        stub_status on;</span><br><span class="line">        access_log off;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/xI51JrHpjO9FZXQ.png"
                      alt="elasticsearch-75.png"
                ></p>
<ol start="3">
<li>重启 nginx</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192 nginx]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/pED5VGyQjUsBCaT.png"
                      alt="elasticsearch-76.png"
                ></p>
<p>结果说明：</p>
<ul>
<li>Active connections：正在处理的活动连接数</li>
<li>server accepts handled requests<ul>
<li>第一个 server 表示 Nginx 启动到现在共处理了 1 个连接</li>
<li>第二个 accepts 表示 Nginx 启动到现在共成功创建 1 词握手</li>
<li>第三个 handled requests 表示总共处理了 2 次请求</li>
<li>请求丢失数&#x3D;握手数-连接数，可以看出目前为止没有丢失请求</li>
</ul>
</li>
<li>Reading：0   Writing：1   Wating：0<ul>
<li>Reading：Nginx 读取到客户端的 header 信息数</li>
<li>Writing：Nginx 返回给客户端 Header 信息数</li>
<li>Wating：Nginx 已经处理完正在等候下一次请求指令的驻留链接（开启 keep-alive 的情况下，这个值等于 Active-(Reading+Writing)）</li>
</ul>
</li>
</ul>
<ol start="3">
<li>配置 nginx module</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@192 nginx]<span class="comment"># metricbeat modules enable nginx</span></span><br><span class="line">Enabled nginx</span><br><span class="line"></span><br><span class="line">[root@192 nginx]<span class="comment"># vim /etc/metricbeat/modules.d/nginx.yml</span></span><br><span class="line">hosts: [<span class="string">&quot;http://192.168.56.135&quot;</span>]      //修改 nginx 的链接地址</span><br><span class="line">server_status_path: <span class="string">&quot;nginx-status&quot;</span>    //添加 nginx 状态路径（必须和 web 的路径相同）</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>启动 metricbeat</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192 metricbeat]<span class="comment"># metricbeat -e</span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/riyIBvzlfuSo1wK.png"
                      alt="elasticsearch-77.png"
                ></p>
<h2 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h2><p>Kibana 是一个为 Elasticsearch 平台分析和可视化的开源平台，使用 Kibana 能够搜索、展示存储在 Elasticsearch 中的索引数据。使用它可以很方便用图表、表格、地图展示和分析数据。<br>Kibana 能够轻松处理大量数据，通过浏览器接口能够轻松的创建和分享仪表盘，通过改变Elasticsearch查询时间，可以完成动态仪表盘。</p>
<h3 id="部署安装"><a href="#部署安装" class="headerlink" title="部署安装"></a>部署安装</h3><ol>
<li>安装 kibana</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192 ~]<span class="comment"># rpm -ivh kibana-7.6.2-x86_64.rpm</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 kibana</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@192 ~]<span class="comment"># vim /etc/kibana/kibana.yml</span></span><br><span class="line">//取消注释，并修改如下两行</span><br><span class="line">server.host: <span class="string">&quot;192.168.56.135&quot;</span>   //对外暴露的服务器地址</span><br><span class="line">elasticsearch.hosts: [<span class="string">&quot;http://192.168.56.135:9200&quot;</span>]   //elasticsearch 服务器地址</span><br><span class="line">i18n.locale: <span class="string">&quot;zh-CN&quot;</span>    //语言配置为中文</span><br><span class="line"></span><br><span class="line">[root@192 ~]<span class="comment"># systemctl start kibana</span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/pUwXs1muonWEMk3.png"
                      alt="elasticsearch-78.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/lq2RdIMyeNwP14Z.png"
                      alt="elasticsearch-79.png"
                ></p>
<ol start="3">
<li>数据探索<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/UHCaoAlOKe8Nn1D.png"
                      alt="elasticsearch-80.png"
                ></li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/bgNFXKGDPW59EzB.png"
                      alt="elasticsearch-81.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/YoHqB2IzaRMj54v.png"
                      alt="elasticsearch-82.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/tLyIFrncuz5ZbCg.png"
                      alt="elasticsearch-83.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/jZMBzmKt6ngJYRy.png"
                      alt="elasticsearch-84.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/a4eYtGQ5AsT1olk.png"
                      alt="elasticsearch-85.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/jsxdirJyvSu6FDI.png"
                      alt="elasticsearch-86.png"
                ></p>
<h3 id="metricbeat-仪表盘安装"><a href="#metricbeat-仪表盘安装" class="headerlink" title="metricbeat 仪表盘安装"></a>metricbeat 仪表盘安装</h3><ol>
<li>配置 metricbeat</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@192 ~]<span class="comment"># vim /etc/metricbeat/metricbeat.yml</span></span><br><span class="line">setup.kibana:</span><br><span class="line">  host: <span class="string">&quot;192.168.56.135:5601&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装仪表盘</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@192 ~]<span class="comment"># metricbeat setup --dashboards</span></span><br><span class="line">Loading dashboards (Kibana must be running and reachable)</span><br><span class="line">Loaded dashboards</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>运行 metricbeat</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192 ~]<span class="comment"># metricbeat -e</span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/XP9cgUWLj7REHFN.png"
                      alt="elasticsearch-87.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/qp1PuMLAIJ4wVki.png"
                      alt="elasticsearch-88.png"
                ></p>
<h3 id="nginx-日志仪表盘安装"><a href="#nginx-日志仪表盘安装" class="headerlink" title="nginx 日志仪表盘安装"></a>nginx 日志仪表盘安装</h3><ol>
<li>配置 filebeat 文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@192 ~]<span class="comment"># vim /etc/filebeat/itcast-nginx.yml</span></span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">&quot;192.168.56.135:9200&quot;</span>]</span><br><span class="line">filebeat.config.modules:</span><br><span class="line">  path: <span class="variable">$&#123;path.config&#125;</span>/modules.d/*.yml</span><br><span class="line">  reload.enabled: <span class="literal">false</span></span><br><span class="line">setup.kibana:</span><br><span class="line">  host: <span class="string">&quot;192.168.56.135:5601&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装仪表盘</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@192 filebeat]<span class="comment"># filebeat -c itcast-nginx.yml setup</span></span><br><span class="line">Overwriting ILM policy is disabled. Set `setup.ilm.overwrite:<span class="literal">true</span>` <span class="keyword">for</span> enabling.</span><br><span class="line"></span><br><span class="line">Index setup finished.</span><br><span class="line">Loading dashboards (Kibana must be running and reachable)</span><br><span class="line">Loaded dashboards</span><br><span class="line">Setting up ML using setup --machine-learning is going to be removed <span class="keyword">in</span> 8.0.0. Please use the ML app instead.</span><br><span class="line">See more: https://www.elastic.co/guide/en/elastic-stack-overview/current/xpack-ml.html</span><br><span class="line">Loaded machine learning job configurations</span><br><span class="line">Loaded Ingest pipelines</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>运行 filebeat</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192 filebeat]<span class="comment"># filebeat -e -c itcast-nginx.yml</span></span><br></pre></td></tr></table></figure>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/eWlPAbRUc3wy4j2.png"
                      alt="elasticsearch-89.png"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/XmTGSU2Zr7wi6V9.png"
                      alt="elasticsearch-90.png"
                ></p>
<h3 id="开发者工具"><a href="#开发者工具" class="headerlink" title="开发者工具"></a>开发者工具</h3><ol>
<li><p>创建索引<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/NIRpmsePucy51rO.png"
                      alt="elasticsearch-91.png"
                ></p>
</li>
<li><p>创建数据<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/YbXo72BIOMnAZ9T.png"
                      alt="elasticsearch-92.png"
                ><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/06/20/L8IDloR1WXfziY7.png"
                      alt="elasticsearch-93.png"
                ></p>
</li>
</ol>
<h2 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h2><p>简单来说 logstash 就是具备实时数据传输能力的管道，负责将数据信息从管道的输入端传输到管道的输出端；与此同时这根管道还可以让你根据自己的需求在中间加上滤网，Logstash 提供里很多功能强大的滤网以满足你的各种应用场景。</p>
<h3 id="部署安装-1"><a href="#部署安装-1" class="headerlink" title="部署安装"></a>部署安装</h3><ol>
<li>安装 jdk1.8（logstash 依赖）</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192 ~]<span class="comment"># yum -y install java</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装logstash</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@192 ~]<span class="comment"># rpm -ivh logstash-7.6.2.rpm</span></span><br><span class="line">警告：logstash-7.6.2.rpm: 头V4 RSA/SHA512 Signature, 密钥 ID d88e42b4: NOKEY</span><br><span class="line">准备中...                          <span class="comment">################################# [100%]</span></span><br><span class="line">        软件包 logstash-1:7.6.2-1.noarch 已经安装</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>自动生成 logstash.service  启动程序，创建软连接</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@192 ~]<span class="comment"># /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd</span></span><br><span class="line">Using provided startup.options file: /etc/logstash/startup.options</span><br><span class="line">Manually creating startup <span class="keyword">for</span> specified platform: systemd</span><br><span class="line">OpenJDK 64-Bit Server VM warning: If the number of processors is expected to increase from one, <span class="keyword">then</span> you should configure the number of parallel GC threads appropriately using -XX:ParallelGCThreads=N</span><br><span class="line">/usr/share/logstash/vendor/bundle/jruby/2.5.0/gems/pleaserun-0.0.30/lib/pleaserun/platform/base.rb:112: warning: constant ::Fixnum is deprecated</span><br><span class="line">Successfully created system startup script <span class="keyword">for</span> Logstash</span><br><span class="line"></span><br><span class="line">[root@192 ~]<span class="comment"># ln -s /usr/share/logstash/bin/logstash /usr/bin/logstash</span></span><br></pre></td></tr></table></figure>

<h3 id="从-shell-中读取输出信息"><a href="#从-shell-中读取输出信息" class="headerlink" title="从 shell 中读取输出信息"></a>从 shell 中读取输出信息</h3><ol>
<li>创建 logstash 配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@192 ~]<span class="comment"># vim std.conf</span></span><br><span class="line">// 脚本的作用是，将用户在 shell 中输入的字符，作为管道输入；将 shell 的输出作为管道输出</span><br><span class="line">input &#123;</span><br><span class="line">    stdin &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>运行logstash</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//测试脚本是否有问题</span><br><span class="line">[root@localhost ~]<span class="comment"># logstash -f std.conf --config.test_and_exit</span></span><br><span class="line"></span><br><span class="line">//执行管道配置文件</span><br><span class="line">[root@localhost ~]<span class="comment"># logstash -f std.conf</span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/04/27/Myaufr3FYWQ7vtG.png"
                      alt="logstash-conf.png"
                ></p>
<h3 id="从日志文件中读取信息"><a href="#从日志文件中读取信息" class="headerlink" title="从日志文件中读取信息"></a>从日志文件中读取信息</h3><ol>
<li>创建日志文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /usr/local/test.log</span></span><br><span class="line">hello logstash!</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim test.conf</span></span><br><span class="line"><span class="comment"># 指定要读取的文件，并以 ruby 程序输出</span></span><br><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">      <span class="comment"># 指定文件路径</span></span><br><span class="line">        path =&gt; [<span class="string">&quot;/usr/local/test.log&quot;</span>]</span><br><span class="line">      <span class="comment"># 将 sincedb 临时文件删除</span></span><br><span class="line">        sincedb_path =&gt; <span class="string">&quot;/dev/null&quot;</span></span><br><span class="line">       <span class="comment"># 从头开始读取文件</span></span><br><span class="line">        start_position =&gt; <span class="string">&quot;beginning&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;</span><br><span class="line">        codec =&gt; rubydebug</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>启动 Logstash</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># logstash -f test.conf</span></span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/04/27/oGQdpKiTP6IgwYy.png"
                      alt="logstash-conf1.png"
                ></p>
<h3 id="从日志文件中读取信息，并输出到执行的文件中"><a href="#从日志文件中读取信息，并输出到执行的文件中" class="headerlink" title="从日志文件中读取信息，并输出到执行的文件中"></a>从日志文件中读取信息，并输出到执行的文件中</h3><ol>
<li>修改配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim test.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; [<span class="string">&quot;/usr/local/test.log&quot;</span>]</span><br><span class="line">        sincedb_path =&gt; <span class="string">&quot;/dev/null&quot;</span></span><br><span class="line">        start_position =&gt; <span class="string">&quot;beginning&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; [<span class="string">&quot;/usr/local/test.log.out&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>启动Logstash</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># /usr/share/logstash/bin/logstash -f test.conf</span></span><br></pre></td></tr></table></figure>

<p>启动后，&#x2F;usr&#x2F;local&#x2F;目录下多了test.log.out文件。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/04/27/rHuz8YRqpM5Ahfw.png"
                      alt="logstash-conf2.png"
                ></p>
<h3 id="Logstash-关联-Elasticsearch-和-Kibana"><a href="#Logstash-关联-Elasticsearch-和-Kibana" class="headerlink" title="Logstash 关联 Elasticsearch 和 Kibana"></a>Logstash 关联 Elasticsearch 和 Kibana</h3><ol>
<li>修改配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim test.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; [<span class="string">&quot;/usr/local/test.log&quot;</span>]</span><br><span class="line">        sincedb_path =&gt; <span class="string">&quot;/dev/null&quot;</span></span><br><span class="line">        start_position =&gt; <span class="string">&quot;beginning&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [<span class="string">&quot;http://192.168.56.128:9200&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>启动Logstash</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># /usr/share/logstash/bin/logstash -f ~/test.conf</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看索引</li>
</ol>
<p>浏览器访问 <a class="link"   target="_blank" rel="noopener" href="http://192.168.56.128:9200/_cat/indices?v" >http://192.168.56.128:9200/_cat/indices?v<i class="fas fa-external-link-alt"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/04/27/l8CEsd9zXqeVuLB.png"
                      alt="logstash-conf3.png"
                ></p>
<blockquote>
<p>其中有个索引是logstash的，这就是我们想要查看的数据索引。</p>
</blockquote>
<ol start="4">
<li>查看数据</li>
</ol>
<p>浏览器访问 <a class="link"   target="_blank" rel="noopener" href="http://192.168.56.128:9200/logstash-2020.04.27-000001/_search" >http://192.168.56.128:9200/logstash-2020.04.27-000001/_search<i class="fas fa-external-link-alt"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/04/27/NsaBrdHEhvCPQi3.png"
                      alt="logstash-conf4.png"
                ></p>
<blockquote>
<p>看到了 hello logstash! ，说明数据已经成功传递到了 Elasticsearch。链接后添加 ?pretty 参数，可以进行格式化显示。</p>
</blockquote>
<ol start="5">
<li>点击页面上的Logs</li>
</ol>
<p>浏览器访问 Kibana <a class="link"   target="_blank" rel="noopener" href="http://192.168.56.128:5601/" >http://192.168.56.128:5601<i class="fas fa-external-link-alt"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/04/28/egQuGF8acVxPEpX.png"
                      alt="logstash-conf5.png"
                ></p>
<ol start="6">
<li>配置日志显示</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/04/28/vstIcjUNnBPkTHQ.png"
                      alt="logstash-conf6.png"
                ></p>
<ol start="7">
<li>填写indices相关信息。</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/04/28/cqCNr2JEWkpaH3m.png"
                      alt="logstash-conf7.png"
                ></p>
<ol start="8">
<li>查看日志显示</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/04/28/o8IfbhmkjHBGteL.png"
                      alt="logstash-conf8.png"
                ></p>
<ol start="9">
<li>修改 test.log</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /usr/local/test.log</span></span><br><span class="line">hello logstash!</span><br><span class="line">the <span class="built_in">log</span> has been updated.</span><br></pre></td></tr></table></figure>

<p>再次查看 Kibana 的日志显示，可以看到更新。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2020/04/28/yWmr3z5FnbdjCSM.png"
                      alt="logstash-conf10.png"
                ></p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a class="link"   target="_blank" rel="noopener" href="https://juejin.im/post/5c7a8e46518825408c2ca004" >剖析ElasticSearch核心概念，NRT，索引，分片，副本等<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="http://leungyukshing.cn/archives/Elasticsearch-basis.html" >ElasticSearch 详解<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://learnku.com/articles/40400" >掌握它才说明你真正懂 Elasticsearch - ES（三）<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.4spaces.org/install-elasticsearch-analysis-ik/" >Elasticsearch 7安装elasticsearch-analysis-ik分词器<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/99358356" >【Elasticsearch 7 探索之路】（六）初识 Mapping<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1hA411h7PT?p=1" >Elastic Stack实战【完结】<i class="fas fa-external-link-alt"></i></a></p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>本文标题：Elastic Stack笔记</li>
        <li>本文作者：9unk</li>
        <li>创建时间：2020-04-30 11:14:25</li>
        <li>
            本文链接：https://9unkk.github.io/2020/04/30/elastic-stack-bi-ji/
        </li>
        <li>
            版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/ELK/">#ELK</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2020/09/06/30-tian-zhi-zuo-cao-zuo-xi-tong/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">30天制作操作系统</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2020/04/16/ubuntu-ri-chang/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">ubuntu日常</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">9unk</a>
        </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Elastic-Stack-%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">Elastic Stack 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch"><span class="nav-number">2.</span> <span class="nav-text">Elasticsearch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">2.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84"><span class="nav-number">2.2.</span> <span class="nav-text">架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%91%E5%AE%9E%E6%97%B6%EF%BC%88Near-Real-Time%EF%BC%89"><span class="nav-number">2.2.1.</span> <span class="nav-text">近实时（Near-Real-Time）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%EF%BC%88Cluster%EF%BC%89"><span class="nav-number">2.2.2.</span> <span class="nav-text">集群（Cluster）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%EF%BC%88Node%EF%BC%89"><span class="nav-number">2.2.3.</span> <span class="nav-text">节点（Node）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%EF%BC%88index%EF%BC%89"><span class="nav-number">2.2.4.</span> <span class="nav-text">索引（index）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%EF%BC%88type%EF%BC%89"><span class="nav-number">2.2.5.</span> <span class="nav-text">类型（type）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%98%A0%E5%B0%84%EF%BC%88mapping%EF%BC%89"><span class="nav-number">2.2.6.</span> <span class="nav-text">映射（mapping）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%EF%BC%88Document%EF%BC%89"><span class="nav-number">2.2.7.</span> <span class="nav-text">文档（Document）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%EF%BC%88field%EF%BC%89"><span class="nav-number">2.2.8.</span> <span class="nav-text">字段（field）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E7%89%87%EF%BC%88shard%EF%BC%89"><span class="nav-number">2.2.9.</span> <span class="nav-text">分片（shard）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%AF%E6%9C%AC%E5%88%86%E7%89%87%EF%BC%88Replica%EF%BC%89"><span class="nav-number">2.2.10.</span> <span class="nav-text">副本分片（Replica）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-number">2.3.</span> <span class="nav-text">基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">2.3.1.</span> <span class="nav-text">创建索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="nav-number">2.3.2.</span> <span class="nav-text">删除索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="nav-number">2.3.3.</span> <span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE"><span class="nav-number">2.3.4.</span> <span class="nav-text">更新数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="nav-number">2.3.5.</span> <span class="nav-text">删除数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%9C%E7%B4%A2%E6%95%B0%E6%8D%AE"><span class="nav-number">2.3.6.</span> <span class="nav-text">搜索数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DLS%E6%90%9C%E7%B4%A2"><span class="nav-number">2.3.7.</span> <span class="nav-text">DLS搜索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AB%98%E4%BA%AE%E6%98%BE%E7%A4%BA"><span class="nav-number">2.3.8.</span> <span class="nav-text">高亮显示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%9A%E5%90%88%EF%BC%88%E7%9B%B8%E5%BD%93%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84-group-by-%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="nav-number">2.3.9.</span> <span class="nav-text">聚合（相当于数据库的 group by 操作）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Elasticsearch-%E6%A0%B8%E5%BF%83%E5%86%85%E5%AE%B9"><span class="nav-number">2.4.</span> <span class="nav-text">Elasticsearch 核心内容</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E6%A1%A3"><span class="nav-number">2.4.1.</span> <span class="nav-text">文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%93%8D%E5%BA%94"><span class="nav-number">2.4.2.</span> <span class="nav-text">查询响应</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E6%96%87%E6%A1%A3%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-number">2.4.3.</span> <span class="nav-text">判断文档是否存在</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="nav-number">2.4.4.</span> <span class="nav-text">批量操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.4.1.</span> <span class="nav-text">批量查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5"><span class="nav-number">2.4.4.2.</span> <span class="nav-text">批量插入</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0"><span class="nav-number">2.4.4.3.</span> <span class="nav-text">批量更新</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%A1%B5"><span class="nav-number">2.4.5.</span> <span class="nav-text">分页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%98%A0%E5%B0%84"><span class="nav-number">2.4.6.</span> <span class="nav-text">映射</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%98%8E%E7%A1%AE%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="nav-number">2.4.6.1.</span> <span class="nav-text">创建明确类型的索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84%EF%BC%88-mapping%EF%BC%89"><span class="nav-number">2.4.6.2.</span> <span class="nav-text">查看映射（ mapping）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE-1"><span class="nav-number">2.4.6.3.</span> <span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"><span class="nav-number">2.4.6.4.</span> <span class="nav-text">查询数据</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.7.</span> <span class="nav-text">结构化查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#term-%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.7.1.</span> <span class="nav-text">term 查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#terms-%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.7.2.</span> <span class="nav-text">terms 查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#range-%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.7.3.</span> <span class="nav-text">range 查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#exists-%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.7.4.</span> <span class="nav-text">exists 查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#match-%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.7.5.</span> <span class="nav-text">match 查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#bool-%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.7.6.</span> <span class="nav-text">bool 查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.7.7.</span> <span class="nav-text">过滤查询</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D"><span class="nav-number">2.4.8.</span> <span class="nav-text">中文分词</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E8%AF%8D"><span class="nav-number">2.4.8.1.</span> <span class="nav-text">什么是分词</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E8%AF%8D-api"><span class="nav-number">2.4.8.2.</span> <span class="nav-text">分词 api</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D-1"><span class="nav-number">2.4.8.3.</span> <span class="nav-text">中文分词</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2"><span class="nav-number">2.4.9.</span> <span class="nav-text">全文搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E6%95%B0%E6%8D%AE"><span class="nav-number">2.4.9.1.</span> <span class="nav-text">构造数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8D%95%E8%AF%8D%E6%90%9C%E7%B4%A2"><span class="nav-number">2.4.9.2.</span> <span class="nav-text">单词搜索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%9A%E8%AF%8D%E6%90%9C%E7%B4%A2"><span class="nav-number">2.4.9.3.</span> <span class="nav-text">多词搜索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%84%E5%90%88%E6%90%9C%E7%B4%A2"><span class="nav-number">2.4.9.4.</span> <span class="nav-text">组合搜索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9D%83%E9%87%8D"><span class="nav-number">2.4.9.5.</span> <span class="nav-text">权重</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#elasticsearch-%E9%9B%86%E7%BE%A4"><span class="nav-number">3.</span> <span class="nav-text">elasticsearch 集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#elasticsearch-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-number">3.1.</span> <span class="nav-text">elasticsearch 集群搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%9A%84%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="nav-number">3.2.</span> <span class="nav-text">集群的故障转移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E6%A1%A3"><span class="nav-number">3.3.</span> <span class="nav-text">分布式文档</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1"><span class="nav-number">3.3.1.</span> <span class="nav-text">路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E5%86%99%E6%93%8D%E4%BD%9C"><span class="nav-number">3.3.2.</span> <span class="nav-text">文档写操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E6%90%9C%E7%B4%A2%EF%BC%88%E5%8D%95%E6%96%87%E6%A1%A3%EF%BC%89"><span class="nav-number">3.3.3.</span> <span class="nav-text">文档搜索（单文档）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2-1"><span class="nav-number">3.3.4.</span> <span class="nav-text">全文搜索</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beats-%E7%AE%80%E4%BB%8B"><span class="nav-number">4.</span> <span class="nav-text">beats 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#filebeat-%E5%85%A5%E9%97%A8"><span class="nav-number">4.1.</span> <span class="nav-text">filebeat 入门</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="nav-number">4.1.1.</span> <span class="nav-text">安装部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="nav-number">4.1.2.</span> <span class="nav-text">读取文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BE%93%E5%87%BA%E5%88%B0-elasticsearch"><span class="nav-number">4.1.3.</span> <span class="nav-text">输出到 elasticsearch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">4.1.4.</span> <span class="nav-text">工作原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96-Nginx-%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="nav-number">4.1.5.</span> <span class="nav-text">读取 Nginx 日志文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Moudule-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">4.1.6.</span> <span class="nav-text">Moudule 的使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Metricbeat"><span class="nav-number">4.2.</span> <span class="nav-text">Metricbeat</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%84%E6%88%90"><span class="nav-number">4.2.1.</span> <span class="nav-text">组成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2"><span class="nav-number">4.2.2.</span> <span class="nav-text">部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#metricbeat-modules"><span class="nav-number">4.2.3.</span> <span class="nav-text">metricbeat modules</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kibana"><span class="nav-number">5.</span> <span class="nav-text">Kibana</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85"><span class="nav-number">5.1.</span> <span class="nav-text">部署安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#metricbeat-%E4%BB%AA%E8%A1%A8%E7%9B%98%E5%AE%89%E8%A3%85"><span class="nav-number">5.2.</span> <span class="nav-text">metricbeat 仪表盘安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx-%E6%97%A5%E5%BF%97%E4%BB%AA%E8%A1%A8%E7%9B%98%E5%AE%89%E8%A3%85"><span class="nav-number">5.3.</span> <span class="nav-text">nginx 日志仪表盘安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7"><span class="nav-number">5.4.</span> <span class="nav-text">开发者工具</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Logstash"><span class="nav-number">6.</span> <span class="nav-text">Logstash</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85-1"><span class="nav-number">6.1.</span> <span class="nav-text">部署安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E-shell-%E4%B8%AD%E8%AF%BB%E5%8F%96%E8%BE%93%E5%87%BA%E4%BF%A1%E6%81%AF"><span class="nav-number">6.2.</span> <span class="nav-text">从 shell 中读取输出信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E4%B8%AD%E8%AF%BB%E5%8F%96%E4%BF%A1%E6%81%AF"><span class="nav-number">6.3.</span> <span class="nav-text">从日志文件中读取信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E4%B8%AD%E8%AF%BB%E5%8F%96%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%B9%B6%E8%BE%93%E5%87%BA%E5%88%B0%E6%89%A7%E8%A1%8C%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%AD"><span class="nav-number">6.4.</span> <span class="nav-text">从日志文件中读取信息，并输出到执行的文件中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Logstash-%E5%85%B3%E8%81%94-Elasticsearch-%E5%92%8C-Kibana"><span class="nav-number">6.5.</span> <span class="nav-text">Logstash 关联 Elasticsearch 和 Kibana</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reference"><span class="nav-number">7.</span> <span class="nav-text">reference</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
